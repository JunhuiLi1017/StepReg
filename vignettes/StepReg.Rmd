---
title: "StepReg: Stepwise Regression Analysis"
author:
- name: Junhui Li
  affiliation: 
  - University of Massachusset Chan medical school, Worcester, USA
- name: Kai Hu
  affiliation: University of Massachusset Chan medical school, Worcester, USA
- name: Xiaohuan Lu
  affiliation: Clark University, Worcester, USA
- name: Julie Lihua Zhu
  affiliation: University of Massachusset Chan medical school, Worcester, USA
- name: Wenxin Liu
  affiliation: China Agricultural University, Beijing, China
package: StepReg
bibliography: bibliography.bib
fontsize: 11pt
nocite: '@*'
link-citations: true
output:
  BiocStyle::html_document:
    toc_float: true
  BiocStyle::pdf_document: default
abstract: |
  A tutorial on employing StepReg for stepwise regression analysis with four well-known datasets namely the mtcars, remission, lung, and CreditCard. The guild showcases the utility of StepReg across four well-known datasets, employing it for different regression models such as linear, logistic, Cox proportional hazard, and Poisson regression. The vignette elucidates the stepwise process with distinct parameters, offering users a clear understanding of how to effectively utilize StepReg for exploratory data analysis and model building in various regression scenarios.

vignette: |
  %\VignetteIndexEntry{StepReg: Stepwise Regression made it simple}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Introduction

Stepwise regression is a widely employed data-mining technique aimed at identifying a valuable subset of predictors for utilization in a multiple regression model. To facilitate this process, we have developed the R package StepReg. Depending on the nature of the response variable, StepReg facilitates users in conducting linear regression for continuous outcomes, logistic regression for binary outcomes, Cox regression for time-to-event outcomes, and Poisson regression for count outcomes, incorporating popular selection criteria. It provides a versatile set of stop rules available in forward selection, backward elimination, both-direction, and best subset methods.

Here, we applied the StepReg package to four well-established and diverse datasets---mtcars, remission, lung, and CreditCard---utilizing distinct parameters across various regression scenarios. These datasets provide robust test cases for showcasing the capabilities and versatility of the StepReg package in real-world applications. Through practical demonstrations, we illustrated the application of linear stepwise regression for continuous outcomes, logistic stepwise regression for binary outcomes, Cox stepwise regression for time-to-event outcomes, and Poisson stepwise regression for count outcomes. These examples offer users valuable insights into the effective utilization of StepReg for variable selection in different regression scenarios, providing a comprehensive guide for those seeking proficiency in incorporating StepReg into their analytical toolkit.

# Features implemented in StepReg package

## Regression categories

**StepReg** supports multiple regressions, including *linear*, *logit*, *cox*, *poisson*, and *gamma* regressions. These methods primarily vary by the type of response variable (refer to the table below). Additional regression techniques can be incorporated upon user request.

```{r, echo = FALSE}
library(knitr)

Regression <- c("linear", "logit", "cox", "poisson", "gamma")
Reponse <- c("continuous", "binary", "time-to-event", "count", "time-series")
df <- data.frame(Regression, Reponse)

kable(df, caption = 'Common regression categories')
```

## Model selection

Model selection aims to identify the subset of independent variables that provide the best predictive performance for the response variable. Both stepwise regression and best subsets approaches are implemented in StepReg. For stepwise regression, there are mainly three methods: *Forward Selection*, *Backward Elimination*, *Bidirectional Elimination*.

### Forward Selection

In forward selection, the algorithm starts with an empty model (no predictors) and adds in variables one by one. Each step tests the addition of every possible predictor by calculating a pre-selected model fit score. Add the variable (if any) whose inclusion leads to the most statistically significant fit improvement. Repeat this process until more predictors no longer lead to a statistically better fit.

### Backward Elimination

In backward elimination, the algorithm starts with a full model (all predictors) and deletes variables one by one. Each step test the deletion of every possible predictor by calculating a pre-selected model fit score. Delete the variable (if any) whose loss leads to the most statistically significant fit improvement. Repeat this process until less predictors no longer lead to a statistically better fit.

### Bidirectional Elimination

Bidirectional elimination is essentially a forward selection procedure combined with backward elimination at each iteration. Each iteration starts with a forward selection step that adds in predictors, followed by a round of backward elimination that removes predictors. Repeat this process until no more predictors are added or excluded.

### Best Subsets

Stepwise algorithms add or delete one predictor at a time and output a single model without evaluating all candidates. Therefore, it is a relatively simple procedure that only produces one model. In contrast, the *Best Subsets* algorithm calculates all possible models and output the best-fitting models with one predictor, two predictors, etc., for users to choose from.

## Selection criterion

The *selection criterion* is another name for the aforementioned *model fit score*. It is a means of evaluating a model's quality by estimating its predictive performance. The following selection criteria have been implemented in StepReg:

```{r, echo = FALSE}
library(knitr)

Criterion <- c("AIC", "AICc", "BIC", "CP", "HQ", "HQc",  "IC(1)", "IC(3/2)", "SL", "SBC", "Rsq", "adjRsq")
Linear <-    c("✓",    "✓",    "✓",   "✓",  "✓",  "✓",    "",      "",        "✓",   "✓",  "✓",   "✓")
Logit <-     c("✓",    "✓",    " ",   " ",  "✓",  "✓",    "✓",      "✓",      "✓",   "✓",  " ",   " ")
Cox <-       c("✓",    "✓",    " ",   " ",  "✓",  "✓",    "✓",      "✓",      "✓",   "✓",  " ",   " ")
Poisson <-   c("✓",    "✓",    " ",   " ",  "✓",  "✓",    "✓",      "✓",      "✓",   "✓",  " ",   " ")
Gamma <-     c("✓",    "✓",    " ",   " ",  "✓",  "✓",    "✓",      "✓",      "✓",   "✓",  " ",   " ")

df <- data.frame(Criterion, Linear, Logit, Cox, Poisson, Gamma)

kable(df, caption = 'Availability of Information Criterion for Regression')
```

For details on each criterion, see below: [@Benjamini1995]

```{r, echo = FALSE}
library(kableExtra)
Criterion <- c("AIC", "AICc", "BIC", "CP", "HQ", "HQc",  "IC(1)", "IC(3/2)", "SL", "SBC", "Rsq", "adjRsq")
Difination <- c("Akaike’s information criterion",
                "sample-size adjusted AIC",
                "Sawa Bayesian information criterion",
                "Mallows’ Cp statistic",
                "Hannan and Quinn information criterion",
                "Corrected Hannan and Quinn information criterion",
                "Information Criterion with Penalty Coefficient Set to 1",
                "Information Criterion with Penalty Coefficient Set to 3/2",
                "Significance Level(pvalue)",
                "Schwarz information criterion",
                "R-squared",
                "adjusted Rsq")
Formula_Linear_univariate <- c("$n\\ln\\left(\\frac{SSE}{n}\\right) + 2p + n + 2$\n[@Benjamini1995]",
                              "$n \\ln\\left(\\frac{SSE}{n}\\right) + \\frac{n(n+p)}{n-p-2}$",
                              "$n \\ln\\left(\\frac{SSE}{n}\\right) + 2(p+2)o - 2o^2, \\quad o = \\frac{n\\sigma^2}{SSE}$",
                              "$\\frac{SSE}{\\sigma^2} + 2p - n$",
                              "$n \\ln\\left(\\frac{SSE}{n}\\right) + \\frac{2p \\ln(\\ln(n))}{n}$",
                              "$n \\ln\\left(\\frac{SSE}{n}\\right) + \\frac{2p \\ln(\\ln(n))}{n-p-2}$",
                              "currently not available",
                              "currently not available",
                              "\\textit{F test}",
                              "$n \\ln\\left(\\frac{SSE}{n}\\right) + p \\ln(n)$",
                              " ",
                              " ")

Formula_Linear_multivariate <- c("$\\ln(|\\text{SSE}_{\\text{det}}|) + \\frac{2pq + q(q+1)}{n}$",
                              "$\\ln(|\\text{SSE}_{\\text{det}}|) + \\frac{q(n+p)}{n-p-q-1}$",
                              "",
                              "",
                              "$\\ln(|\\text{SSE}_{\\text{det}}|) + \\frac{2pq\\ln(\\ln(n))}{n}$",
                              "$n \\ln\\left(\\frac{SSE}{n}\\right) + \\frac{2p \\ln(\\ln(n))}{n-p-2}$",
                              "currently not available",
                              "currently not available",
                              "\\textit{Approximate F test}",
                              "$\\ln(|\\text{SSE}_{\\text{det}}|) + \\frac{p \\ln(n)}{n}$",
                              " ",
                              " ")
Formula_Logit_Cox_Poisson_Gamma <- c("$-2{LL} + 2p$",
                              "$-2{LL} + \\frac{n(n+p)}{n-p-2}$",
                              "",
                              "",
                              "$-2{LL} + \\frac{2p\\ln(\\ln(n))}{n}$",
                              "$-2{LL} + \\frac{2p \\ln(\\ln(n))}{n-p-2}$",
                              "$-2{LL} + p$",
                              "$-2{LL} + \\frac{3}{2}p$",
                              "logistic and Poisson: score and LRT test for forward, wald test for backward; Cox: LRT test for forward, wald test for backward",
                              "$-2{LL} + p\\ln(n)$",
                              "NA",
                              "NA")
df <- data.frame(Criterion, Difination, Formula_Linear_univariate, Formula_Linear_multivariate,Formula_Logit_Cox_Poisson_Gamma)
kable_styling(kable(df, format = "html", align='l', booktabs=TRUE, escape = F, caption = 'Abbreviation, Definition, and Formula of the Information Criterion') %>%
                footnote(
                   number=c("
${n}$: Sample Size; 
${p}$: Number of parameters including the intercept;
${k}$:	Number of independent variables in the full model;
${q}$:	Number of dependent variables;
$\\sigma^2$:	Estimate of pure error variance from fitting the full model, which is the average of sigma value when it is for multivariate multiple regression;
${df}$:	Degree of freedom;
${SST}$:	Total sum of squares corrected for the mean for the dependent variable, which is a numeric and matrix for univariate regression and multivariate regression correspondingly;
${SSE}$:	Error sum of squares, which is a numeric and matrix for univariate regression and multivariate regression correspondingly;
${LL}$:	The natural logarithm of likelihood;
${I}$:	The identity of matrix of size (${q} x {q}$);
${SSEdet}$:	The determinant of matrix SSE;
${SSTdet}$:	The determinant of matrix SST;
${| |}$:	The absolute value;
$\\ln()$:	The natural logarithm;
"),
                   footnote_as_chunk=TRUE, 
                   escape=FALSE))
```


Table2: Criterion Definition Formula Note AIC (linear) AIC (cox)

-   For linear regression:
    -   AIC: Akaike information criterion
    -   AICc: sample-size adjusted AIC
    -   BIC: Bayesian information criterion
    -   Mallows's Cp
    -   HQ: Hannan-Quinn information criterion
    -   HQc: Corrected Hannan and Quinn information criterion, reference see [here](https://www.jstatsoft.org/article/view/v007i12)
    -   Rsq: R-squared
    -   adjRsq: adjusted Rseq
    -   SBC: Schwarz information criterion
    -   SL (Pvalue, based on F-test or Approximate F-test): Significance level
-   For logistic, Poisson and cox regression
    -   AIC: Akaike information criterion
    -   AICc: sample-size adjusted AIC
    -   HQ: Hannan-Quinn information criterion
    -   HQc: Corrected Hannan and Quinn information criterion, reference see [here](https://www.jstatsoft.org/article/view/v007i12)
    -   IC(3/2):
    -   IC(1):
    -   SBC: Schwarz information criterion
    -   SL (Pvalue): Significance level(logistic and Poisson: score and LRT test for forward, wald test for backward; Cox: LRT test for forward, wald test for backward)

## Multicollinearity

A breif introduction for four datasets is descripted as below,

-   [**mtcars**](https://cran.r-project.org/web/packages/explore/vignettes/explore_mtcars.html): the mtcars dataset is a classic automotive dataset that provides information on various car models and their performance attributes. With 32 observations and 11 variables, it includes details such as miles per gallon (mpg), horsepower, and the number of cylinders.

-   [**remission**](https://online.stat.psu.edu/stat501/book/export/html/1011): the remission dataset is relevant in the context of medical research, specifically in oncology. It captures data related to the remission status of leukemia patients. The dataset includes variables such as cellularity of the marrow clot section, the highest temperature before the start of treatment, and remission status (1 for remission and 0 for non-remission).

-   [**lung**](https://stat.ethz.ch/R-manual/R-devel/library/survival/html/lung.html): the lung dataset is a dataset in the survival analysis domain, containing information related to the survival times of 228 patients with advanced lung cancer. It includes variables such as the patient's age, the type of treatment received, and survival status.

-   [**CreditCard**](https://search.r-project.org/CRAN/refmans/AER/html/CreditCard.html): the CreditCard dataset is associated with credit risk analysis and financial research. It contains information about credit card transactions, including details such as the amount spent, credit limit, and payment status.

# StepReg Output

A list containing multiple tables will be returned. Names and descriptions of each table are outlined as follows:

-   `Table 1. Summary of Parameters`: This table presents the parameters utilized in stepwise regression along with their default or user-specified values.

-   `Table 2. Variables and Types`: This table outlines the variables and their respective types utilized in the dataset.

-   `Table names prefixed with Table. Selection Process`: This table details overview of the variable selection process. Variables are selected based on information criteria rules, such as AIC, BIC, SBC, IC(1), HQ, etc., where lower values indicate better model fit. The significance levels include SLE for the entry of variables in forward selection and SLS for staying in backward elimination. For Rsq or adjusted R-squared, higher values indicate a better model fit.

-   `Tabel names prefixed with Table. Parameter Estimates`: This table provides summary information for the optimal models.

# Demo

This section provides 9 examples utilizing distinct parameters across various regression scenarios with the above 4 datasets.

## linear stepwise regression with `mtcars`

> **Example1**: In this analysis, we used `mpg` as the response variable, with all other variables serving as predictors, employing a strategy of `forward` and a metric of `AIC` for linear stepwise regression. The analysis involved enforcing `disp` and `cyl` to be included in all models.

```{r}
    library(StepReg)
    data(mtcars)
    formula <- mpg ~ .
    exam1 <- stepwise(formula = formula,
                      data = mtcars,
                      type = "linear",
                      include = c("disp","cyl"),
                      strategy = "forward",
                      metric = "AIC")
    exam1
```

> Visulization of the selection process using information criteron `AIC`.

```{r plot_exam1, warning=FALSE}
    plot(exam1)
```

> **Example2**: In this illustration, we maintained `mpg` as the response variable, while designating the other variables as predictors. The chosen strategy was `bidirectional` with `AIC`, `AICc`, `BIC`,`HQ`, `HQc`, `SBC`, and `SL` as the stopping criterion, and the significance levels for entry (`sle`) and stay (`sls`) were both set to 0.05 parallelly. The analysis involved removing `intercept` from the model. The specific characteristics of the data and the goals of the analysis in each subject area require users to choose different stepwise regression method and selection criteria. Users can compare all metics through the output list or the plots.

```{r}
    formula <- mpg ~ . + 0
    exam2 <- stepwise(formula = formula,
                      data = mtcars,
                      type = "linear",
                      strategy = "bidirection",
                      metric = c("AIC","SBC","SL","AICc","BIC","HQ","HQc"),
                      sle = 0.05,
                      sls = 0.05)
    exam2
```

> Visulization of the selection process using `bidirection` strategy under information criteron `AIC`, `AICc`, `BIC`,`HQ`, `HQc`, `SBC`, and `SL` with `sle`=0.05 and `sls`=0.05.

```{r plot_exam2, warning=FALSE}
    plot(exam2)
```

> **Example3**: In this multivariable multiple stepwise regression, we employed `mpg` and `drat` as response with `cyl`, `disp`, `hp`, `wt`, `vs` and `am` serving as predictors. The variable `wt` was enforced to be included in all models. The analysis involved the `subset` strategy for variable selection, with `AIC` and `AICc` as the criteria individually.

```{r}
    formula <- cbind(mpg,drat) ~ cyl + disp + hp + wt + vs + am
    exam3 <- stepwise(formula = formula,
                      data = mtcars,
                      type = "linear",
                      include = 'wt',
                      strategy = "subset",
                      metric = c("AIC","AICc"),
                      best_n = 3)
    exam3
```

> Visulization of the selection process using `subset` strategy under information criteron `AIC` and `AICc`.

```{r plot_exam3, warning=FALSE}
    plot(exam3)
```

## Logistic stepwise regression with `remission`

> **Example4**: In this run, we employed `remiss` as response with the other 6 variables serving as predictors. The variable `cell` was enforced to be included in all models. The analysis involved the `forward` strategy for variable selection, with `AIC` and `SL` as the criteria parallelly, and the significance levels for entry (`sle`) and stay (`sls`) were both set to 0.05.

```{r warning = FALSE}
    data(remission)
    formula <- remiss ~ .
    exma4 <- stepwise(formula = formula,
                      data = remission,
                      type = "logit",
                      include= "cell",
                      strategy = "forward",
                      metric = c("AIC","SL"),
                      sle = 0.05,
                      sls = 0.05)
    exma4
```

> Visulization of the selection process using `forward` strategy under information criteron `AIC` and `SL`.

```{r plot_exam4, warning=FALSE}
    plot(exma4)
```

> **Example5**: In this anslysis, `remiss` was retained as the response variable, while the other six variables served as predictors. The analysis utilized the `subset` strategy for variable selection, with `AIC` and `SL` as the criterion parallelly.

```{r warning = FALSE}
    data(remission)
    formula <- remiss ~ .
    exma5 <- stepwise(formula = formula,
                      data = remission,
                      type = "logit",
                      strategy = "subset",
                      metric = c("AIC","SL"),
                      best_n = 3)
    exma5
```

> Visulization of the selection process using `subset` strategy under information criteron `AIC` and `SL`.

```{r plot_exam5, warning=FALSE}
    plot(exma5)
```

## Cox stepwise regression with `lung`

> **Example6**: Cox stepwise regression used the `forward` method for variable selection with `IC(1)` and `SL` as the criteria for stop rules parallelly, including variable `age` in all models. The significance levels for enter (`sle`) was set to 0.05.

```{r warning = FALSE}
    lung <- survival::lung
    my.data <- na.omit(lung)
    my.data$status1 <- ifelse(my.data$status == 2,1,0)
    formula  =  Surv(time, status1) ~ . - status 
    
    exma6 <- stepwise(formula = formula,
                      data = my.data,
                      type = "cox",
                      include = "age",
                      strategy = "forward",
                      metric = c("IC(1)","SL"),
                      sle = 0.05)
    exma6
```

> Visulization of the selection process using `forward` strategy under information criteron `IC(1)` and `SL`.

```{r plot_exam6, warning=FALSE}
    plot(exma6)
```

> **Example7**: Cox stepwise regression used the `backward` method for variable selection with `SL` and `AIC` as the criterion. The significance levels for staying (`sls`) was set to 0.05.

```{r warning = FALSE}
    formula = Surv(time, status1) ~ . - status 
    exma7 <- stepwise(formula = formula,
                      data = my.data,
                      type = "cox",
                      strategy = "backward",
                      metric = c("SL","AIC"),
                      sls = 0.05)
    exma7
```

> Visulization of the selection process using `backward` strategy under information criteron `AIC` and `SL`.

```{r plot_exam7, warning=FALSE}
    plot(exma7)
```

## Poisson stepwise regression with `CreditCard`

> **Example8**: In this exmaples, We designated `reports` as the response variable, with the remaining variables serving as predictors. The analysis employed the `forward` method for variable selection, utilizing `SL` and `IC(3/2)` as the criterion for stop rules, and the significance levels for entry (`sle`) was set to be 0.05.

```{r warning = FALSE}
    data(CreditCard, package = 'AER')
    formula  = reports ~ .
    
    exma8 <- stepwise(formula = formula,
                      data = CreditCard,
                      type = "poisson",
                      strategy = "forward",
                      metric = c("SL","IC(3/2)"),
                      sle=0.05)
    exma8
```

> Visulization of the selection process using `forward` strategy under information criteron `IC(3/2)` and `SL`.

```{r plot_exam8, warning=FALSE}
    plot(exma8)
```

> **Example9**: `reports` variable was maintained as the response variable, and the remaining variables were set as predictors. The variables `card` and `months` were enforced to be included in all models. Poisson stepwise regression was performed using the `bidirection` method for variable selection with `IC(3/2)` and `AIC` as the criterion for stop rules parrallelly.

```{r warning = FALSE}
    formula = reports ~ .
    exma9 <- stepwise(formula = formula,
                      data = CreditCard,
                      type = "poisson",
                      include=c("card","months"),
                      strategy = "bidirection",
                      metric = c("IC(3/2)","AIC")
                      )
    exma9
```

> Visulization of the selection process using `bidirection` strategy under information criteron `IC(3/2)` and `AIC`.

```{r plot_exam9, warning=FALSE}
    plot(exma9)
```

# Session Info

```{r sessionInfo, echo = FALSE}
sessionInfo()
```
